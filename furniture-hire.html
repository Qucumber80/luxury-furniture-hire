<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luxurious Furniture Hire</title>
</head>
<body>
  <nav class="top-banner">
    <div class="container nav-container">
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About Us</a></li>
        <li><a href="furniture-hire.html" class="active">Furniture Hire</a></li>
        <li><a href="gallery.html">Gallery</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </div>
  </nav>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f8f8f8;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .furniture-list {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 40px;
    }
    .item {
      border: 1px solid #ccc;
      background: white;
      padding: 15px;
      width: 260px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
      border-radius: 6px;
      text-align: center;
    }
    .item img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 4px;
    }
    .item h3 {
      margin: 10px 0 6px;
      font-size: 1.2rem;
      color: #222;
    }
    .item p {
      margin: 0 0 10px;
      color: #666;
      font-weight: 600;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 600;
    }
    input.flatpickr-input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
      cursor: pointer;
    }
    button {
      background: #bfa760;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      font-weight: 600;
      border-radius: 4px;
      transition: background 0.3s ease;
      margin-top: 10px;
      width: 100%;
    }
    button:hover {
      background: #a38e48;
    }

    /* Basket Styles */
    .basket {
      position: fixed;
      right: 20px;
      top: 80px;
      width: 320px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
      border-radius: 6px;
      font-size: 14px;
    }
    .basket h3 {
      margin-top: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      font-size: 1.4rem;
    }
    .basket-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-weight: 600;
      color: #333;
    }
    .basket-item button {
      background: #e74c3c;
      border: none;
      color: white;
      padding: 4px 8px;
      font-size: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .basket-item button:hover {
      background: #c0392b;
    }
    #basket-total {
      font-size: 1.3rem;
      color: #bfa760;
      font-weight: 700;
      margin-top: 10px;
      display: block;
      text-align: right;
    }
  </style>

  <h1>Furniture Hire</h1>

  <div class="furniture-list">
    <div class="item" data-id="1" data-price="50">
      <img src="images/chain-bed.jpg" alt="Chain-Bed" />
      <h3>Chain Bed</h3>
      <p>£50 per day</p>
      <label for="start-1">Start Date:</label>
      <input type="text" id="start-1" placeholder="Select start date" readonly />
      <label for="end-1">End Date:</label>
      <input type="text" id="end-1" placeholder="Select end date" readonly />
      <button onclick="addToBasketWithDates(1)">Add to Basket</button>
    </div>

    <div class="item" data-id="2" data-price="30">
      <img src="images/flog.jpg" alt="Flog" />
      <h3>Flog</h3>
      <p>£30 per day</p>
      <label for="start-2">Start Date:</label>
      <input type="text" id="start-2" placeholder="Select start date" readonly />
      <label for="end-2">End Date:</label>
      <input type="text" id="end-2" placeholder="Select end date" readonly />
      <button onclick="addToBasketWithDates(2)">Add to Basket</button>
    </div>

    <div class="item" data-id="3" data-price="40">
      <img src="images/lock-and-key.jpg" alt="Chains" />
      <h3>Chains</h3>
      <p>£40 per day</p>
      <label for="start-3">Start Date:</label>
      <input type="text" id="start-3" placeholder="Select start date" readonly />
      <label for="end-3">End Date:</label>
      <input type="text" id="end-3" placeholder="Select end date" readonly />
      <button onclick="addToBasketWithDates(3)">Add to Basket</button>
    </div>
  </div>

  <div class="basket" id="basket">
    <h3>Your Basket</h3>
    <div id="basket-items"></div>
    <p><strong>Total: £<span id="basket-total">0</span></strong></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    const furnitureData = {
      1: { name: "Chain Bed", price: 50 },
      2: { name: "Flog", price: 30 },
      3: { name: "Chains", price: 40 },
    };

    const bookings = {
      1: [
        { start: new Date("2025-06-10"), end: new Date("2025-06-12") },
        { start: new Date("2025-06-20"), end: new Date("2025-06-22") },
      ],
      2: [{ start: new Date("2025-06-15"), end: new Date("2025-06-17") }],
      3: []
    };

    let basket = [];
    const BUFFER_MS = 48 * 60 * 60 * 1000;

    function getBufferedRange(booking) {
      return {
        start: new Date(booking.start.getTime() - BUFFER_MS),
        end: new Date(booking.end.getTime() + BUFFER_MS)
      };
    }

    function rangesOverlap(aStart, aEnd, bStart, bEnd) {
      return aStart <= bEnd && bStart <= aEnd;
    }

    function checkBookingConflict(itemId, startDate, endDate) {
      const desiredStart = new Date(startDate.getTime() - BUFFER_MS);
      const desiredEnd = new Date(endDate.getTime() + BUFFER_MS);

      const itemBookings = bookings[itemId] || [];
      for (const b of itemBookings) {
        const buffered = getBufferedRange(b);
        if (rangesOverlap(desiredStart, desiredEnd, buffered.start, buffered.end)) {
          return true;
        }
      }

      for (const item of basket) {
        if (item.id !== itemId) continue;
        const buffered = getBufferedRange({ start: item.startDate, end: item.endDate });
        if (rangesOverlap(desiredStart, desiredEnd, buffered.start, buffered.end)) {
          return true;
        }
      }

      return false;
    }

    Object.keys(furnitureData).forEach(id => {
      const startInput = document.getElementById(`start-${id}`);
      const endInput = document.getElementById(`end-${id}`);

      const startCalendar = flatpickr(startInput, {
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: generateDisabledDates(id),
        onChange(selectedDates) {
          if (selectedDates.length > 0) {
            endCalendar.set('minDate', selectedDates[0]);
            endCalendar.set('maxDate', addMaxEndDate(selectedDates[0]));
          } else {
            endCalendar.set('minDate', "today");
            endCalendar.set('maxDate', null);
          }
        }
      });

      const endCalendar = flatpickr(endInput, {
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: generateDisabledDates(id)
      });

      furnitureData[id].startCalendar = startCalendar;
      furnitureData[id].endCalendar = endCalendar;
    });

    function addMaxEndDate(startDate) {
      const maxEnd = new Date(startDate);
      maxEnd.setDate(maxEnd.getDate() + 14);
      return maxEnd;
    }

    function generateDisabledDates(itemId) {
      if (!bookings[itemId] || bookings[itemId].length === 0) return [];

      return bookings[itemId].flatMap(booking => {
        const buffered = getBufferedRange(booking);
        return [{ from: buffered.start, to: buffered.end }];
      });
    }

    function addToBasketWithDates(itemId) {
      const startInput = document.getElementById(`start-${itemId}`);
      const endInput = document.getElementById(`end-${itemId}`);

      if (!startInput.value || !endInput.value) {
        alert("Please select both start and end dates.");
        return;
      }

      const startDate = new Date(startInput.value);
      const endDate = new Date(endInput.value);

      if (startDate > endDate) {
        alert("Start date cannot be after end date.");
        return;
      }

      if (startDate.getTime() === endDate.getTime()) {
        alert("Start and end date must be different.");
        return;
      }

      if (checkBookingConflict(itemId, startDate, endDate)) {
        alert("Selected dates overlap with existing booking or buffer period. Please choose different dates.");
        return;
      }

      basket.push({
        id: itemId,
        name: furnitureData[itemId].name,
        price: furnitureData[itemId].price,
        startDate,
        endDate,
        qty: 1
      });

      bookings[itemId].push({ start: startDate, end: endDate });
      refreshCalendars(itemId);

      startInput.value = "";
      endInput.value = "";

      renderBasket();
    }

    function refreshCalendars(itemId) {
      const disabledDates = generateDisabledDates(itemId);
      furnitureData[itemId].startCalendar.set('disable', disabledDates);
      furnitureData[itemId].endCalendar.set('disable', disabledDates);
    }

    function removeFromBasket(index) {
      const removed = basket.splice(index, 1)[0];

      bookings[removed.id] = bookings[removed.id].filter(b => {
        return !(b.start.getTime() === removed.startDate.getTime() &&
                 b.end.getTime() === removed.endDate.getTime());
      });

      refreshCalendars(removed.id);
      renderBasket();
    }

    function renderBasket() {
  const basketItemsDiv = document.getElementById("basket-items");
  basketItemsDiv.innerHTML = "";

  let total = 0;

  basket.forEach((item, index) => {
    const timeDiff = item.endDate.getTime() - item.startDate.getTime();
    const days = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
    const itemTotal = days * item.price * item.qty;
    total += itemTotal;

    const el = document.createElement("div");
    el.className = "basket-item";
    el.innerHTML = `
      <span>
        ${item.name}<br>
        ${days} day${days > 1 ? 's' : ''} hire<br>
        £${itemTotal.toFixed(2)}
      </span>
      <button onclick="removeFromBasket(${index})">Remove</button>
    `;
    basketItemsDiv.appendChild(el);
  });

  document.getElementById("basket-total").textContent = total.toLocaleString(undefined, {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    renderBasket();
  </script>
</body>
</html>
